<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logo stamper</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0f17; color: #e6e9ef; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 24px; }
    h1 { font-size: 28px; margin: 0 0 16px; }
    p { opacity: .85; }
    .card { background: #121826; border: 1px solid #1f283d; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    label { display:block; margin: 12px 0 6px; font-weight: 600; }
    input[type="file"], textarea, select, input[type="number"] {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #2a3552; background: #0f1422; color: #e6e9ef;
    }
    textarea { min-height: 100px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .actions { display:flex; gap:12px; align-items:center; margin-top: 16px; }
    button {
      border: 0; padding: 12px 16px; border-radius: 12px; font-weight: 700; cursor: pointer;
      background: #4b86ff; color: #0b0f17;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 13px; opacity: .8; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#1b2439; border:1px solid #2a3552; display:inline-block; margin-right:6px; }
    .footer { opacity:.7; font-size: 12px; margin-top: 24px;}
    .small { font-size: 12px; opacity: .8; }
    .success { color: #8af28a; }
    .error { color: #ff8080; }
    details { background:#0f1422; border-radius:12px; padding: 12px; border:1px solid #283355; }
    summary { cursor:pointer; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üñºÔ∏è Logo stamper</h1>
    <p class="small">Upload images or paste URLs, choose a language logo, and download the processed file.</p>
    <div class="card">
      <form id="stampForm">
        <div class="row">
          <div>
            <label for="images">Images</label>
            <input id="images" name="images" type="file" accept="image/png,image/jpeg" multiple>
            <div class="hint">You can upload multiple images.</div>
          </div>
          <div>
            <label for="excel">Excel with URLs (optional)</label>
            <input id="excel" name="excel" type="file" accept=".xlsx">
            <div class="hint">First column or a column named <code>url</code> or <code>image_url</code>.</div>
          </div>
        </div>

        <label for="urls">Or paste image URLs</label>
        <textarea id="urls" name="urls" placeholder="One URL per line"></textarea>

        <div class="row">
          <div>
            <label for="language">Language</label>
            <select id="language" name="language" required>
              <option value="" disabled selected>Loading...</option>
            </select>
            <div class="hint">Languages are discovered from the <code>logos/</code> folder on the server.</div>
          </div>
          <div>
            <label for="scale">Logo scale</label>
            <input id="scale" name="logo_scale" type="number" step="0.01" min="0.05" max="1" value="0.40">
            <div class="hint">Fraction of image width. Example: 0.12 means 12%.</div>
          </div>
        </div>

        <div class="actions">
          <button id="submitBtn" type="submit">Stamp logos</button>
          <span id="status" class="pill">Idle</span>
        </div>
      </form>
      <div id="result" class="small"></div>
    </div>

    <div class="footer">
      <span class="pill">Python</span> <span class="pill">Flask</span> <span class="pill">Vercel functions</span> <span class="pill">Pillow</span>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const languageSelect = document.getElementById('language');
    const form = document.getElementById('stampForm');
    const submitBtn = document.getElementById('submitBtn');
    const resultEl = document.getElementById('result');

    async function loadLanguages() {
      try {
        let res = await fetch('/api/languages');
        if (!res.ok) { res = await fetch('/api/languages.py'); }
        const data = await res.json();
        languageSelect.innerHTML = '<option value="" disabled selected>Select language</option>';
        data.languages.forEach(lang => {
          const opt = document.createElement('option');
          opt.value = lang;
          opt.textContent = lang;
          languageSelect.appendChild(opt);
        });
      } catch (e) {
        languageSelect.innerHTML = '<option value="" disabled selected>Could not load languages</option>';
      }
    }
    loadLanguages();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Uploading';
      submitBtn.disabled = true;
      resultEl.textContent = '';

      const fd = new FormData(form);
      // Coalesce URLs textarea into multiple 'url' fields
      const urlsText = document.getElementById('urls').value.trim();
      if (urlsText) {
        urlsText.split(/\r?\n/).map(u => u.trim()).filter(Boolean).forEach(u => {
          fd.append('url', u);
        });
      }

      try {
        const res = await fetch('/api/add_logo', { method: 'POST', body: fd });
        const blob = await res.blob();
        if (!res.ok) {
          const text = await blob.text();
          throw new Error(text || 'Request failed');
        }
        const disposition = res.headers.get('Content-Disposition') || '';
        const match = /filename="?([^"]+)"?/.exec(disposition);
        const filename = match ? match[1] : 'result.bin';
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        resultEl.innerHTML = '<span class="success">Done. Your download should begin now.</span>';
      } catch (err) {
        resultEl.innerHTML = '<span class="error">Error: ' + (err.message || err) + '</span>';
      } finally {
        submitBtn.disabled = false;
        statusEl.textContent = 'Idle';
      }
    });
  </script>
</body>
</html>
